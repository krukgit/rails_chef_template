# variables
<% server_name = (node.chef_environment == 'production' ? '' : node.chef_environment) + node[cookbook_name]['server_url'] %>

# ELB Health Check
server {
    listen 81;

    if ($http_user_agent !~ "ELB-HealthChecker") {
       return 403;
    }

    return 200;
}

<% if node.chef_environment == 'production' %>
# Redirect
server {
    listen       80;
    server_name  www.<%= server_name %>;
    return       301 https://<%= server_name %>$request_uri;
}
<% end %>

# Rails server
server {
    listen 80;
    root <%= node[cookbook_name]['project_dir'] %>/current/public;
    server_name <%= server_name %>;
    passenger_enabled on;
    rails_env <%= node.chef_environment %>;
    client_max_body_size 20m;

<% if node.chef_environment == 'staging' %>
    location  /  {
        auth_basic            "Restricted";
        auth_basic_user_file  <%= node[cookbook_name]['project_dir'] %>/shared/.htpasswd;
        passenger_enabled on;
    }
<% end %>

    location /blog {
        proxy_pass https://blog.<%= server_name %>/;
    }
}

<% if node.run_list.include? "recipe[#{cookbook_name}::wordpress]" %>
# Wordpress server
server {
    listen 80;
    root <%= node[cookbook_name]['wordpress']['dir'] %>;
    server_name blog.<%= server_name %>;
    client_max_body_size 20m;

    index    index.html  index.php;
    try_files $uri $uri/ /blog/index.php?q=$uri&$args;

    if (!-e $request_filename) {
        rewrite ^.+?(/blog/.*.php)$ $1 last;
        rewrite ^ /blog/index.php last;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_intercept_errors on;
        include fastcgi_params;
        fastcgi_index  index.php;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
    }
}
<% end %>
